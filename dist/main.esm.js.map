{"version":3,"file":"main.esm.js","sources":["../src/core/utils.ts","../src/core/index.ts","../src/core/polyfill.ts","../src/index.ts"],"sourcesContent":["// 生成唯一的值\nlet uid = 0;\nconst symbolPolyfill = function(prefix = \"__special\"): string {\n  return `${prefix}${uid++}`;\n};\n// 将对象拼接成字符串\nconst splicingParams = function(o: Object): string {\n  let text = \"\";\n  o = o || {};\n  for (const name in o) {\n    if (o.hasOwnProperty(name)) {\n      const value = o[name];\n      text += `${name}=${value}&`;\n    }\n  }\n  // 给第一个字符添加?同时去掉最后一个&\n  if (text.length) {\n    text = `?${text.slice(0, -1)}`;\n  }\n  return text;\n};\n// 解析url的params\nconst analysisParams = function(url: string) {\n  const index = url.indexOf(\"?\") + 1;\n  const o: {\n    [propName: string]: any;\n  } = {};\n  if (!index) {\n    return {\n      url,\n      params: o\n    };\n  }\n  const u = url.slice(index);\n  const arr = u.split(\"&\");\n  for (let item of arr) {\n    const [name, value] = item.split(\"=\");\n    o[name] = value;\n  }\n  return { url: url.slice(0, index - 1), params: o };\n};\nexport { symbolPolyfill, splicingParams, analysisParams };\n","import { symbolPolyfill, splicingParams, analysisParams } from \"./utils\";\ndeclare global {\n  interface Window {\n    [props: string]: any;\n  }\n  interface Object {\n    [props: string]: any;\n  }\n}\ninterface Ioptions {\n  params?: Object;\n  timeout?: number;\n  name?: string;\n  prefix?: string;\n}\ntype callback = (type: Error, data: any) => void;\nconst getName = function getName(prefix: string) {\n  let name = symbolPolyfill(prefix);\n  while (window[name]) {\n    name = symbolPolyfill(prefix);\n  }\n  return name;\n};\nconst jsonp = function jsonp(\n  this: any,\n  url: string,\n  option?: Ioptions,\n  fn?: callback\n) {\n  let { params: par, url: urls } = analysisParams(url);\n  url = urls;\n  // 交换一下参数\n  if (!option) {\n    option = {};\n  }\n  if (typeof option === \"function\") {\n    fn = option;\n    option = {};\n  }\n  const { name = \"callback\", timeout = 10000, params = {}, prefix } = option;\n  const id = getName(prefix);\n  // 如果成功给回调函数传递值\n  window[id] = (data: any) => {\n    clear();\n    if (typeof fn !== \"function\") {\n      return;\n    }\n    fn.call(this, null, data);\n  };\n  params[name] = id;\n  par = Object.assign(par, params);\n  let timer: NodeJS.Timeout;\n  if (typeof timeout === \"number\") {\n    timer = setTimeout(() => {\n      clear();\n      if (typeof fn !== \"function\") {\n        return;\n      }\n      fn.call(this, new Error(`Task timeout`));\n    }, timeout);\n  }\n  const script = document.createElement(\"script\");\n  const href = encodeURI(`${url}${splicingParams(par)}`);\n\n  script.src = href;\n  script.onerror = () => {\n    clear();\n    if (typeof fn !== \"function\") {\n      return;\n    }\n    fn.call(\n      this,\n      new Error(`Failed to create jsonp, request target address is:${url}`)\n    );\n  };\n  document.body.appendChild(script);\n  // 取消函数\n  function clear() {\n    if (script.parentElement) {\n      script.parentElement.removeChild(script);\n    }\n    if (timer) {\n      clearTimeout(timer);\n    }\n    // 防止多次执行\n    window[id] = () => {};\n  }\n  return clear;\n};\nexport { Ioptions, callback };\nexport default jsonp;\n","if (typeof Object.assign != \"function\") {\n  Object.assign = function assign(target: any, varArgs: any) {\n    // .length of function is 2\n    \"use strict\";\n    if (target == null) {\n      // TypeError if undefined or null\n      throw new TypeError(\"Cannot convert undefined or null to object\");\n    }\n\n    let to = Object(target);\n\n    for (var index = 1; index < arguments.length; index++) {\n      var nextSource = arguments[index];\n\n      if (nextSource != null) {\n        // Skip over if undefined or null\n        for (let nextKey in nextSource) {\n          // Avoid bugs when hasOwnProperty is shadowed\n          if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\n            to[nextKey] = nextSource[nextKey];\n          }\n        }\n      }\n    }\n    return to;\n  };\n}\n","import index from \"./core/index\";\nimport \"./core/polyfill\";\nimport { Ioptions } from \"./core/index\";\n\n// 代理一下\nconst jsonp = function(url: string, option?: Ioptions) {\n  let cancel: Function;\n  const promise = new Promise((resolve, reject) => {\n    cancel = index(url, option, (err, data) => {\n      if (err) {\n        return reject(err);\n      }\n      return resolve(data);\n    });\n  });\n  return {\n    cancel,\n    promise\n  };\n};\n\nexport default jsonp;\nexport { index as callback, jsonp as get };\n"],"names":["jsonp","index"],"mappings":"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"}