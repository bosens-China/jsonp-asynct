{"version":3,"file":"main.esm.min.js","sources":["../src/utils.ts","../src/main.ts"],"sourcesContent":["// 简单判断一下是否支持promise\nexport const isPromise = (): boolean => {\n  if (typeof Promise !== 'function') {\n    return false;\n  }\n  const obj = Promise.resolve();\n  return !!obj.then;\n};\n\nexport const includes = (str: string, query: string) => {\n  return str.indexOf(query) !== -1;\n};\n","import Ijsonp, { IOption, ICallback } from '../typings/type';\nimport { isPromise, includes } from './utils';\n\ninterface Ifn<T> extends ICallback<T> {\n  resolve?: (data: T) => void;\n  reject?: (err: Error) => void;\n}\n\nconst isCallback = <T>(obj: any): obj is ICallback<T> => {\n  return typeof obj === 'function';\n};\n\n// 全局计数器\nlet count = 0;\n\nconst jsonp = function <T = any>(\n  url: string,\n  parameter?: Record<string, any> | ICallback<T>,\n  option?: IOption | ICallback<T>,\n  callback?: ICallback<T>,\n): any {\n  // 确定参数位置，需要考虑重载parameter属性进行必要填充\n  let parameterRequire: Record<string, any> = {};\n  let optionRequire = {} as Required<IOption>;\n  let callbackRequire: ICallback<T> = isCallback(callback) ? callback : () => {};\n\n  if (isCallback(parameter)) {\n    callbackRequire = parameter;\n  } else {\n    parameterRequire = parameter || {};\n  }\n  if (isCallback(option)) {\n    callbackRequire = option;\n  } else {\n    optionRequire = ((option || {}) as unknown) as Required<IOption>;\n  }\n  // 初始化option属性\n  optionRequire.param = optionRequire.param || 'callback';\n  optionRequire.timeout = optionRequire.timeout || 60000;\n  optionRequire.prefix = optionRequire.prefix || '__jp';\n  optionRequire.name = optionRequire.name || `${optionRequire.prefix}${count++}`;\n  // param对于jsonp是必须的\n  parameterRequire[optionRequire.param] = optionRequire.name;\n\n  // 拼接url\n  const parameterStr = Object.keys(parameterRequire).reduce((x, y) => {\n    const value = parameterRequire[y];\n    const str = `${x}&${y}=${encodeURIComponent(value)}`;\n    return str;\n  }, '');\n\n  let completeUrl = (!includes(url, '?') ? `${url}?` : `${url}&`) + parameterStr;\n  // 处理下边界情况，parameter肯定是存在一个的，所以不需要处理 /?$/ 的情况\n  completeUrl = completeUrl.replace(/(\\?&)/, '?').replace(/&&/, '&');\n  window[optionRequire.name] = (data: T): void => {\n    fn(null, data);\n  };\n\n  let times: NodeJS.Timeout | null = null;\n  const src = document.createElement('script');\n\n  const cancel = () => {\n    if (times) {\n      clearTimeout(times);\n    }\n    window[optionRequire.name] = null;\n    document.body.removeChild(src);\n  };\n\n  // fn 函数这样定义是为了执行可能存在的promise\n  const fn = (((err: null | Error, data: T) => {\n    callbackRequire(err, data);\n    if (err && fn.reject) {\n      fn.reject(err);\n    }\n    if (!err && fn.resolve) {\n      fn.resolve(data);\n    }\n    cancel();\n  }) as unknown) as Ifn<T>;\n\n  // 设置超时\n  if (typeof optionRequire.timeout === 'number' && optionRequire.timeout > 0) {\n    times = setTimeout(() => {\n      fn(new Error(`request timeout`));\n    }, optionRequire.timeout);\n  }\n\n  // 发送请求\n  src.src = completeUrl;\n  src.onerror = () => {\n    fn(new Error(`Failed to create script tag. The current SRC is:${completeUrl}`));\n  };\n  document.body.appendChild(src);\n\n  if (isPromise()) {\n    return new Promise((resolve, reject) => {\n      // 修改参数，等待异步调用\n      fn.resolve = resolve;\n      fn.reject = reject;\n    });\n  }\n  return undefined;\n} as Ijsonp;\n\nexport default jsonp;\n"],"names":["isCallback","obj","count","url","parameter","option","callback","parameterRequire","optionRequire","callbackRequire","param","timeout","prefix","name","query","parameterStr","Object","keys","reduce","x","y","value","encodeURIComponent","completeUrl","indexOf","replace","window","data","fn","times","src","document","createElement","err","reject","resolve","clearTimeout","body","removeChild","setTimeout","Error","onerror","appendChild","Promise","then"],"mappings":"AACO,ICODA,EAAa,SAAIC,GACrB,MAAsB,mBAARA,GAIZC,EAAQ,iBAEE,SACZC,EACAC,EACAC,EACAC,GAGA,IAAIC,EAAwC,GACxCC,EAAgB,GAChBC,EAAgCT,EAAWM,GAAYA,EAAW,aAElEN,EAAWI,GACbK,EAAkBL,EAElBG,EAAmBH,GAAa,GAE9BJ,EAAWK,GACbI,EAAkBJ,EAElBG,EAAkBH,GAAU,GAG9BG,EAAcE,MAAQF,EAAcE,OAAS,WAC7CF,EAAcG,QAAUH,EAAcG,SAAW,IACjDH,EAAcI,OAASJ,EAAcI,QAAU,OAC/CJ,EAAcK,KAAOL,EAAcK,MAAQ,GAAGL,EAAcI,OAASV,IAErEK,EAAiBC,EAAcE,OAASF,EAAcK,KAGtD,IDpCoCC,ECoC9BC,EAAeC,OAAOC,KAAKV,GAAkBW,QAAO,SAACC,EAAGC,GAC5D,IAAMC,EAAQd,EAAiBa,GAE/B,OADeD,MAAKC,MAAKE,mBAAmBD,KAE3C,IAECE,GD1CgCT,EC0CF,MDzCH,ICyCFX,EDzClBqB,QAAQV,GCyCyBX,MAAYA,OAAUY,GAElEQ,EAAcA,EAAYE,QAAQ,QAAS,KAAKA,QAAQ,KAAM,KAC9DC,OAAOlB,EAAcK,MAAQ,SAACc,GAC5BC,EAAG,KAAMD,IAGX,IAAIE,EAA+B,KAC7BC,EAAMC,SAASC,cAAc,UAW7BJ,WAAQK,EAAmBN,GAC/BlB,EAAgBwB,EAAKN,GACjBM,GAAOL,EAAGM,QACZN,EAAGM,OAAOD,IAEPA,GAAOL,EAAGO,SACbP,EAAGO,QAAQR,GAdTE,GACFO,aAAaP,GAEfH,OAAOlB,EAAcK,MAAQ,KAC7BkB,SAASM,KAAKC,YAAYR,IA6B5B,GAbqC,iBAA1BtB,EAAcG,SAAwBH,EAAcG,QAAU,IACvEkB,EAAQU,YAAW,WACjBX,EAAG,IAAIY,MAAM,sBACZhC,EAAcG,UAInBmB,EAAIA,IAAMP,EACVO,EAAIW,QAAU,WACZb,EAAG,IAAIY,MAAM,mDAAmDjB,KAElEQ,SAASM,KAAKK,YAAYZ,GD3FH,mBAAZa,SAGCA,QAAQR,UACPS,KC0FX,OAAO,IAAID,SAAQ,SAACR,EAASD,GAE3BN,EAAGO,QAAUA,EACbP,EAAGM,OAASA"}