{"version":3,"file":"main.js","sources":["../src/core/utils.ts","../src/core/index.ts","../src/core/polyfill.ts","../src/index.ts"],"sourcesContent":["// 生成唯一的值\nlet uid = 0;\nconst symbolPolyfill = function(prefix = \"__special\"): string {\n  return `${prefix}${uid++}`;\n};\n// 将对象拼接成字符串\nconst splicingParams = function(o: Object): string {\n  let text = \"\";\n  o = o || {};\n  for (const name in o) {\n    if (o.hasOwnProperty(name)) {\n      const value = o[name];\n      text += `${name}=${value}&`;\n    }\n  }\n  // 给第一个字符添加?同时去掉最后一个&\n  if (text.length) {\n    text = `?${text.slice(0, -1)}`;\n  }\n  return text;\n};\n// 解析url的params\nconst analysisParams = function(url: string) {\n  const index = url.indexOf(\"?\") + 1;\n  const o: {\n    [propName: string]: any;\n  } = {};\n  if (!index) {\n    return {\n      url,\n      params: o\n    };\n  }\n  const u = url.slice(index);\n  const arr = u.split(\"&\");\n  for (let item of arr) {\n    const [name, value] = item.split(\"=\");\n    o[name] = value;\n  }\n  return { url: url.slice(0, index - 1), params: o };\n};\nexport { symbolPolyfill, splicingParams, analysisParams };\n","import { symbolPolyfill, splicingParams, analysisParams } from \"./utils\";\ndeclare global {\n  interface Window {\n    [props: string]: any;\n  }\n  interface Object {\n    [props: string]: any;\n  }\n}\ninterface Ioptions {\n  params?: Object;\n  timeout?: number;\n  name?: string;\n  prefix?: string;\n}\ntype callback = (type: Error, data: any) => void;\nconst getName = function getName(prefix: string) {\n  let name = symbolPolyfill(prefix);\n  while (window[name]) {\n    name = symbolPolyfill(prefix);\n  }\n  return name;\n};\nconst jsonp = function jsonp(\n  this: any,\n  url: string,\n  option?: Ioptions,\n  fn?: callback\n) {\n  let { params: par, url: urls } = analysisParams(url);\n  url = urls;\n  // 交换一下参数\n  if (!option) {\n    option = {};\n  }\n  if (typeof option === \"function\") {\n    fn = option;\n    option = {};\n  }\n  const { name = \"callback\", timeout = 60000, params = {}, prefix } = option;\n  const id = getName(prefix);\n  // 如果成功给回调函数传递值\n  window[id] = (data: any) => {\n    clear();\n    if (typeof fn !== \"function\") {\n      return;\n    }\n    fn.call(this, null, data);\n  };\n  params[name] = id;\n  par = Object.assign(par, params);\n  let timer: NodeJS.Timeout;\n  if (typeof timeout === \"number\") {\n    timer = setTimeout(() => {\n      clear();\n      if (typeof fn !== \"function\") {\n        return;\n      }\n      fn.call(this, new Error(`Task timeout`));\n    }, timeout);\n  }\n  const script = document.createElement(\"script\");\n  const href = encodeURI(`${url}${splicingParams(par)}`);\n\n  script.setAttribute(\"scr\", href);\n  script.addEventListener(\"error\", () => {\n    clear();\n    if (typeof fn !== \"function\") {\n      return;\n    }\n    fn.call(\n      this,\n      new Error(`Failed to create jsonp, request target address is:${url}`)\n    );\n  });\n  document.body.appendChild(script);\n  // 取消函数\n  function clear() {\n    if (script.parentElement) {\n      script.parentElement.removeChild(script);\n    }\n    if (timer) {\n      clearTimeout(timer);\n    }\n    // 防止多次执行\n    window[id] = () => {};\n  }\n  return clear;\n};\nexport { Ioptions, callback };\nexport default jsonp;\n","if (typeof Object.assign != \"function\") {\n  // Must be writable: true, enumerable: false, configurable: true\n  Object.defineProperty(Object, \"assign\", {\n    value: function assign(target: any, varArgs: any) {\n      // .length of function is 2\n      \"use strict\";\n      if (target == null) {\n        // TypeError if undefined or null\n        throw new TypeError(\"Cannot convert undefined or null to object\");\n      }\n\n      let to = Object(target);\n\n      for (var index = 1; index < arguments.length; index++) {\n        var nextSource = arguments[index];\n\n        if (nextSource != null) {\n          // Skip over if undefined or null\n          for (let nextKey in nextSource) {\n            // Avoid bugs when hasOwnProperty is shadowed\n            if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\n              to[nextKey] = nextSource[nextKey];\n            }\n          }\n        }\n      }\n      return to;\n    },\n    writable: true,\n    configurable: true\n  });\n}\n","import index from \"./core/index\";\nimport \"./core/polyfill\";\nimport { Ioptions } from \"./core/index\";\n\n// 代理一下\nconst jsonp = function(url: string, option?: Ioptions) {\n  let cancel: Function;\n  const promise = new Promise((resolve, reject) => {\n    cancel = index(url, option, (err, data) => {\n      if (err) {\n        return reject(err);\n      }\n      return resolve(data);\n    });\n  });\n  return {\n    cancel,\n    promise\n  };\n};\n\nexport default jsonp;\nexport { index as callback, jsonp as get };\n"],"names":["jsonp","index"],"mappings":";;;;;;EACA,IAAI,GAAG,GAAG,CAAC,CAAC;EACZ,IAAM,cAAc,GAAG,UAAS,MAAoB;MAApB,uBAAA,EAAA,oBAAoB;MAClD,OAAO,KAAG,MAAM,GAAG,GAAG,EAAI,CAAC;EAC7B,CAAC,CAAC;EAEF,IAAM,cAAc,GAAG,UAAS,CAAS;MACvC,IAAI,IAAI,GAAG,EAAE,CAAC;MACd,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;MACZ,KAAK,IAAM,MAAI,IAAI,CAAC,EAAE;UACpB,IAAI,CAAC,CAAC,cAAc,CAAC,MAAI,CAAC,EAAE;cAC1B,IAAM,KAAK,GAAG,CAAC,CAAC,MAAI,CAAC,CAAC;cACtB,IAAI,IAAO,MAAI,SAAI,KAAK,MAAG,CAAC;WAC7B;OACF;MAED,IAAI,IAAI,CAAC,MAAM,EAAE;UACf,IAAI,GAAG,MAAI,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAG,CAAC;OAChC;MACD,OAAO,IAAI,CAAC;EACd,CAAC,CAAC;EAEF,IAAM,cAAc,GAAG,UAAS,GAAW;MACzC,IAAM,KAAK,GAAG,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;MACnC,IAAM,CAAC,GAEH,EAAE,CAAC;MACP,IAAI,CAAC,KAAK,EAAE;UACV,OAAO;cACL,GAAG,KAAA;cACH,MAAM,EAAE,CAAC;WACV,CAAC;OACH;MACD,IAAM,CAAC,GAAG,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;MAC3B,IAAM,GAAG,GAAG,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;MACzB,KAAiB,UAAG,EAAH,WAAG,EAAH,iBAAG,EAAH,IAAG,EAAE;UAAjB,IAAI,IAAI,YAAA;UACL,IAAA,oBAA+B,EAA9B,cAAI,EAAE,aAAwB,CAAC;UACtC,CAAC,CAAC,MAAI,CAAC,GAAG,KAAK,CAAC;OACjB;MACD,OAAO,EAAE,GAAG,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC;EACrD,CAAC,CAAC;;ECxBF,IAAM,OAAO,GAAG,SAAS,OAAO,CAAC,MAAc;MAC7C,IAAI,IAAI,GAAG,cAAc,CAAC,MAAM,CAAC,CAAC;MAClC,OAAO,MAAM,CAAC,IAAI,CAAC,EAAE;UACnB,IAAI,GAAG,cAAc,CAAC,MAAM,CAAC,CAAC;OAC/B;MACD,OAAO,IAAI,CAAC;EACd,CAAC,CAAC;EACF,IAAM,KAAK,GAAG,SAAS,KAAK,CAE1B,GAAW,EACX,MAAiB,EACjB,EAAa;MAJD,iBAiEb;MA3DK,IAAA,wBAAgD,EAA9C,eAAW,EAAE,aAAiC,CAAC;MACrD,GAAG,GAAG,IAAI,CAAC;MAEX,IAAI,CAAC,MAAM,EAAE;UACX,MAAM,GAAG,EAAE,CAAC;OACb;MACD,IAAI,OAAO,MAAM,KAAK,UAAU,EAAE;UAChC,EAAE,GAAG,MAAM,CAAC;UACZ,MAAM,GAAG,EAAE,CAAC;OACb;MACO,IAAA,gBAAiB,EAAjB,sCAAiB,EAAE,mBAAe,EAAf,oCAAe,EAAE,kBAAW,EAAX,gCAAW,EAAE,sBAAM,CAAY;MAC3E,IAAM,EAAE,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;MAE3B,MAAM,CAAC,EAAE,CAAC,GAAG,UAAC,IAAS;UACrB,KAAK,EAAE,CAAC;UACR,IAAI,OAAO,EAAE,KAAK,UAAU,EAAE;cAC5B,OAAO;WACR;UACD,EAAE,CAAC,IAAI,CAAC,KAAI,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;OAC3B,CAAC;MACF,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC;MAClB,GAAG,GAAG,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;MACjC,IAAI,KAAqB,CAAC;MAC1B,IAAI,OAAO,OAAO,KAAK,QAAQ,EAAE;UAC/B,KAAK,GAAG,UAAU,CAAC;cACjB,KAAK,EAAE,CAAC;cACR,IAAI,OAAO,EAAE,KAAK,UAAU,EAAE;kBAC5B,OAAO;eACR;cACD,EAAE,CAAC,IAAI,CAAC,KAAI,EAAE,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC;WAC1C,EAAE,OAAO,CAAC,CAAC;OACb;MACD,IAAM,MAAM,GAAG,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;MAChD,IAAM,IAAI,GAAG,SAAS,CAAC,KAAG,GAAG,GAAG,cAAc,CAAC,GAAG,CAAG,CAAC,CAAC;MAEvD,MAAM,CAAC,YAAY,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;MACjC,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE;UAC/B,KAAK,EAAE,CAAC;UACR,IAAI,OAAO,EAAE,KAAK,UAAU,EAAE;cAC5B,OAAO;WACR;UACD,EAAE,CAAC,IAAI,CACL,KAAI,EACJ,IAAI,KAAK,CAAC,uDAAqD,GAAK,CAAC,CACtE,CAAC;OACH,CAAC,CAAC;MACH,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;MAElC,SAAS,KAAK;UACZ,IAAI,MAAM,CAAC,aAAa,EAAE;cACxB,MAAM,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;WAC1C;UACD,IAAI,KAAK,EAAE;cACT,YAAY,CAAC,KAAK,CAAC,CAAC;WACrB;UAED,MAAM,CAAC,EAAE,CAAC,GAAG,eAAQ,CAAC;OACvB;MACD,OAAO,KAAK,CAAC;EACf,CAAC,CAAC;;ECxFF,IAAI,OAAO,MAAM,CAAC,MAAM,IAAI,UAAU,EAAE;MAEtC,MAAM,CAAC,cAAc,CAAC,MAAM,EAAE,QAAQ,EAAE;UACtC,KAAK,EAAE,SAAS,MAAM,CAAC,MAAW,EAAE,OAAY;cAG9C,IAAI,MAAM,IAAI,IAAI,EAAE;kBAElB,MAAM,IAAI,SAAS,CAAC,4CAA4C,CAAC,CAAC;eACnE;cAED,IAAI,EAAE,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC;cAExB,KAAK,IAAI,KAAK,GAAG,CAAC,EAAE,KAAK,GAAG,SAAS,CAAC,MAAM,EAAE,KAAK,EAAE,EAAE;kBACrD,IAAI,UAAU,GAAG,SAAS,CAAC,KAAK,CAAC,CAAC;kBAElC,IAAI,UAAU,IAAI,IAAI,EAAE;sBAEtB,KAAK,IAAI,OAAO,IAAI,UAAU,EAAE;0BAE9B,IAAI,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,UAAU,EAAE,OAAO,CAAC,EAAE;8BAC7D,EAAE,CAAC,OAAO,CAAC,GAAG,UAAU,CAAC,OAAO,CAAC,CAAC;2BACnC;uBACF;mBACF;eACF;cACD,OAAO,EAAE,CAAC;WACX;UACD,QAAQ,EAAE,IAAI;UACd,YAAY,EAAE,IAAI;OACnB,CAAC,CAAC;GACJ;;MC1BKA,OAAK,GAAG,UAAS,GAAW,EAAE,MAAiB;MACnD,IAAI,MAAgB,CAAC;MACrB,IAAM,OAAO,GAAG,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;UAC1C,MAAM,GAAGC,KAAK,CAAC,GAAG,EAAE,MAAM,EAAE,UAAC,GAAG,EAAE,IAAI;cACpC,IAAI,GAAG,EAAE;kBACP,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC;eACpB;cACD,OAAO,OAAO,CAAC,IAAI,CAAC,CAAC;WACtB,CAAC,CAAC;OACJ,CAAC,CAAC;MACH,OAAO;UACL,MAAM,QAAA;UACN,OAAO,SAAA;OACR,CAAC;EACJ,CAAC;;;;;;;;;;;;;;"}